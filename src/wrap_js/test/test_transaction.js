var wally = require('../wally');
var test = require('tape');

const SIGHASH_ALL = 0x01;
const WALLY_TX_FLAG_USE_WITNESS = 1;
const WALLY_TX_FLAG_USE_ELEMENTS = 2;
const EC_FLAG_ECDSA = 1;

const cases = [
    {
        'tx_hex':'020000000001472fc28aae3654a6883ca2cae79027a4cb29938e9b697c58efe634b68db7bd710100000000ffffffff0201f38611eb688e6fcd06f25e2faf52b9f98364dc14c379ab085f1b57d56b4b1a6f01000000003b7c4580001976a914a3b57adba4a92dcd71295a5abf53a3560deca33d88ac01f38611eb688e6fcd06f25e2faf52b9f98364dc14c379ab085f1b57d56b4b1a6f0100000000001e8480000000000000',
        'tx_hash':'cbde35814ac091a2e46f0f1ad80da519092a7c03da58672c888d1413b9c6f1da',
        'signature':'c1f40be83361cd42233fad226f42e1abec2f5d2da13f3c37b2c8a4db44ee98a01ea49f5d25047fa5046c9fa24af0a07b5e88bfe82a4f923239e3cf703f94502f',
        'der':'3045022100c1f40be83361cd42233fad226f42e1abec2f5d2da13f3c37b2c8a4db44ee98a002201ea49f5d25047fa5046c9fa24af0a07b5e88bfe82a4f923239e3cf703f94502f',
        'signed_tx':'020000000001472fc28aae3654a6883ca2cae79027a4cb29938e9b697c58efe634b68db7bd71010000006b483045022100c1f40be83361cd42233fad226f42e1abec2f5d2da13f3c37b2c8a4db44ee98a002201ea49f5d25047fa5046c9fa24af0a07b5e88bfe82a4f923239e3cf703f94502f012103379181919a0925651f945ad91a1637007be9bd7e3be6db97907732d406a4a65effffffff0201f38611eb688e6fcd06f25e2faf52b9f98364dc14c379ab085f1b57d56b4b1a6f01000000003b7c4580001976a914a3b57adba4a92dcd71295a5abf53a3560deca33d88ac01f38611eb688e6fcd06f25e2faf52b9f98364dc14c379ab085f1b57d56b4b1a6f0100000000001e8480000000000000'
    },
    {
        'tx_hex':'0200000001011eef7c29ba6eedbdd282debec712726c95bc0718b30070ccf2100241d014db8c0000000000ffffffff020af4585e33e92cf3a40d0d23d2af03e8e34cebeedf3c9a32fb76ce43a96b04a58e0928d442a43a0625091356c77cf3a2139d9eac2a15613e02139d93925cef0d07df02bffa41b1f71e34174e64e5c7e7a061e058f07526c364c6a78690b985420866fd1976a914a3b57adba4a92dcd71295a5abf53a3560deca33d88ac01f38611eb688e6fcd06f25e2faf52b9f98364dc14c379ab085f1b57d56b4b1a6f0100000000001e84800000000000000000000043010001af7afe0fac8958cb5e29f2bf7cbffa583d697642fc52202593844de0198eda2416c3d709acb082e2436ca4684242580edfd9e23a05fc1d22381b66e9ce7b41a8fd4d0b60230000000000000001e0250118a0844aa445459d910745838083a32b4459d0f3c48dbee068a3acddbf036f144b92c8498c81f8394bc8ac9328812c72ea5912dd7b2751b438e0044458d8f9a982002438aad8dfb4d82670c5fb8581adc5ec9995c2985c1bbda20e06bacad0e2d64cf6276c14dc636f2a4c1ef90e3fdd26da2a14ebef073007515135b6b723f0d7fa0ddaa3a26d8236848f971f3e46e1f0987c51637b2a5cc3592a7e9e9f51d46abf4eba9c4af01eb5bb0f43bcbc2ac3cf9c353599a352e5c1a8eb14a6e1a933a8f27ed8eddc42d9b5300ddc65dc8e7762680a766309295afcf104ac9dd01c3e6dfdf21c4ea2c1e204c16a5e26e5dc9497d3fe68165306cb15796a49e0faf29a57a63254c8bb2510d4640c70ec554827134f5320e5145004d1f9057d726e72aca6cc1302d8e65cd72c04fd0acad31a76fb8e26e09a0588f938d45a9af2dc2eef0ff730ab5db565907dffd95f0081f5ed4dfa20ba1fc90e77fe847a5987b74cf579bc637c3899019789f5cf01f456b8ad25b5a1f93c3f6a094e10b6f4ff0cc33baa232c1eeba64d228611360478a46f3684f3f6baef85de2c464fcc8cf555f144f3d9064f9fca49cf4a6d386bc9e972c412e6883ede59276dd4f987d1cee9a62f3056aff7e8de491dc4fb3091e825fac882f78d65d8869dc6c6a92c1c29ca1b4c6697f1fbc82c19bc87903e6e641712d642fcf98ccad976d548f05be51ecc8e3fc187c480a05f24038fd181bc725d1bfec6660918547ba5c0cc52bc84bfe060cbee79d1282f29c9188d9e419750c876db5d617054f63e0102bd2ac4dceeb1eb35d7f21ff89d33abe327f50b439e0a40df60d7180434afac2533b527b0a09c03e9ec584139c998a8c40c219c02b3e46d2906449a5718534ae42bb08b7280c642232c7d096145a5cf55a506e7cda90b3680bc6741d2c49d607b82e7d385a83c39f3588f6a800da67e8e2bc52ddf3d0af57b13fa30fea69029c81f31d6024241fe07f2220daa82f48a22c7cf2cddc37d8c2825474937c06503454bed674be66272351b9e2594e5dc51c0d368bfa7317b8d6cd38513560aa23d3de94077013cac08c754a03541a8166cb84f0e42c54e854bf1dc4ab360c602edb757c002f525adb73bed3b02ddd2be6a15946a4fcf7df05b6fc5fb25ef53776b842a892c333a211b03ef93976d632487e537b7d29e6c729b689c653d583c1f84d893cbfd93d022234d56d18d6913634fd84c13c7355ac079ed241f63002cc66c4c1039a6cc7bfaa0b829f26029e24084f333b62285a38c7691443b1c46c4b16770eeb98df095d3fb0b2d8e1672f44a2917dcbe8ba0b34455531f4f70cbbfa0a3ba29e910ff89f3abb03cda9b18e94cfb0fe7a06be47b4ebe55516c12d934d77b3094021bcb8eae0ab2c0682431ea241fe31297e012d50a37495bd3213389b3f1773e4b71f3e36af7acfd76fbfe5efd05a72079f9b435487deff0af39cc9494aa6701ecd13c8df63e903bd393f019dd142c9bfd32ed907979ec6b5538e0f83f3d241b7b5c1ec43a768b9b9633a270f1cd52a6a8e0e24ab42320ccef65068b8dbabe11ada9c52fb2397d95fd80e01883741c9cf432fa595b0478927287b8fc97fe2b32b31beec70e01cfd33c2bcfc99843f37aa79ee26420cd353efaa6af07a86e9c5bb78cc6dc660f8f90082166afda7376aace01a647fa1c0f7bd4331fc746c0b289cce18394e94a06650064a4a5714b3ec7b2ff0601d2c47b333f474a9081c03b67d60d76f5106b433a1f75548bc94dc0dbed2ebc530b97461b6b2d7b389bde139508efab618aad0a00b7a4f7432711822edda850f4d016b54650a19380c9d6d8f35d1f8895b10efd6bafa8974aae10ba06ce6b8d543e0e6901caabfc2e2d93143a10ddc0c4eb224b1b667531da61d86f4c8f0ef8c3a1d1af0452883b5c509f5e3a94bbf258900dcb95fb44c4f014711dcd7709f807b02ed73739728d49f7bf77f875f0e08d4d4f66bc737680f9be446d47b8df09307fff17cfbda0e5f7b643f67dcc5e8c0cb617a55fc7c5c4d90f82c3227c847a269b59a5ba158e807b40d3597be6864965a94383b54f78211a9db2086e3506f9c2be3f1f594a3f6e1b7ff4132d07ad434985bbaf433522a253b680350b45cfeba3f01c2c879491e91da708721f742bddbe95fd4bb85864e2441cd2b18a0e52c00a93b4949fe55554046e6ca3cb375529a9047fad2d94e7d9d637cfc14a98bac83a09486f77a12820f855ee049e585dc22beac15623bcd46ca7fe0ed22bb2207b391219f5e6f17f3601dda5cd0f447f4415773f3d335838bf1cac8ebe30c272eb7fdd84dd5cf23e5d828c465917484c33253bf8d55ea526730537f3778064261c1ffc9771984bed7a8735d9ab2ac5d77a0a92cd36a4d599aad2f995093aa850c5189c3474eb88a5011d9a7f8fa384fbd67a6b72d16558b9189549c6b6741a8e39545061a26132830c52587e7a17e341db0f814bc9805d61e585afd6b80773708d9a1ca5fd7b3cbd9858c70956cd4653907dca3ea7514b5c9ec6b792c8784ea1dce31a7f995ac0f6cd8944f2de17a534b9246edd6f3244576da984ea68fda9e2517c5999d38d9a93b95d6feab3d116ee58e944102745c0665e6e96d5174ffdbbb8ead695426cf75d846c3a984a7dc6b160c77f3ee6183e0d25128570b2f408437c026dc81d096ed2b9af5d2bda88a559e622d2dc003e6f69f6f668f2f0395908ea0d4397af1ba67d765ea5b29014a7ef5c4912274d1ab9f03d4ec620bf5a6898f52c16c913261f8247fe2f4fe2a0e66dd5de328aaa47261233b122f742e1847b4b17f50a4a8884f972e8acc4ae5b05ee3a6b89644dc7a96e69e2af6e7c7610c2b37c46eca8476809df0bfa80ecccecc57039701b7ed1eea672bcd040ffd008fe04adf08c7de800c87a5e8765b190448e750697ee0c4b2799087cea4cf4ed629f4bdadb3c34dfe2ae8d713d422e2e278965d8df3524bbc51a0245aea62da7ae9eddf50a05e68f64831cf87af74a913a6f1a72658729f20156a9015290b146f0e1d4e952a2c41029a6c99f3fcc04d137a581e4d79783060e48cb0a15f2cbe700ead4a5c76f4e358732dad40cbcb3ef22f7c23cc83cc2cb87c0f1a0af7ea0ff2b2f07d3295c5802c72a5259adcd62b811266acff286ca82e8a82a472507482903dc19cef48b7667e70272d88749e16358221d81fa6fce2fc0f7a09a47977591c1ea8c1b68e90d51bc71ac2f6c75d4da55a1001d0f0bda00d6fcc5214abd612fecfa574f1261b155e53d7796eb20f4f79e1a5f5d998550dcec04519089a76ac54ceee539ec0e083c9fe086e987c4f57e851be2de566bd16b1b1b0c1a6bf50b7358dad05b430524c24caa54da966d3089cde72d56dfbde10bbf145c0a463bafacc5d60482e0379007de62b479b220efa1ec03237d4660ebe750978ed36beeaa5120f88cd452c27a8d3c272eb0e63e51090760aeabb290c9bad499df11bf483fe0abbff5a776ccf6257d2cab760913239dd95e60b83df7ecccd4bbcebf4bdb058af3fd03db1303a8a2c351410862edc4b7f0eb69d4fbe91c4be12128645bd69149ad7cbead16a01d4fbc0031b065bb388752fc1a4c638c4a22134fd7a95c0674b2db433fca6a0738ca4b96b39d4f8aec2a44e1e3847d917c5724f1d92b3a0eb4398f9bf21bd38d7cdf233212462e233eac78a3863cffa3e60e526bf18ff28c01e1ee66fb0dfd2d1b071e8fdf93e0d5a04f9d02092d8ea79c9cff46db900acfd12f469d3cdfe7afc8ef5a7da92e561ab9cabab7711bdbcf630030f2cc2dd1494a64768125b7f450aa825cedb0f7224e17a59d7e2b3409b406ee5d31548f35d07336886b53bb30fb3ae233dfeffabc1763efb2cf6430dd07a0aad33636254f90cbbbf1eca63f52f72bae63c3b74ff3f522a0f1b1e61c7ea60222e09444184ba342a935c4e8d028398fe8b602cbe11b441c96007d3233d5adac8425fa1334282cc689a6b49a7c21ad092738a7317bb6e34328b77e7077aeff9a52db2aedf24cb318e740e0486e9763390fd6660d52ca76de07aa7b564540815a0000',
        'tx_hash':'acacadfc7044307c3dd9d24ab48dfe933617ca85fef3332ba84eb1e350e0dee9',
        'signature':'5b15572dc690e59688c2b4a6e01a02e112fdb8ccb269e968cd5519ca4af58a5b124fc61a57a1b8b8719de88d9ee18c1cf0bf29a6d53ff076efbb02f1ba78760e',
        'der':'304402205b15572dc690e59688c2b4a6e01a02e112fdb8ccb269e968cd5519ca4af58a5b0220124fc61a57a1b8b8719de88d9ee18c1cf0bf29a6d53ff076efbb02f1ba78760e',
        'signed_tx':'0200000001011eef7c29ba6eedbdd282debec712726c95bc0718b30070ccf2100241d014db8c000000006a47304402205b15572dc690e59688c2b4a6e01a02e112fdb8ccb269e968cd5519ca4af58a5b0220124fc61a57a1b8b8719de88d9ee18c1cf0bf29a6d53ff076efbb02f1ba78760e012103379181919a0925651f945ad91a1637007be9bd7e3be6db97907732d406a4a65effffffff020af4585e33e92cf3a40d0d23d2af03e8e34cebeedf3c9a32fb76ce43a96b04a58e0928d442a43a0625091356c77cf3a2139d9eac2a15613e02139d93925cef0d07df02bffa41b1f71e34174e64e5c7e7a061e058f07526c364c6a78690b985420866fd1976a914a3b57adba4a92dcd71295a5abf53a3560deca33d88ac01f38611eb688e6fcd06f25e2faf52b9f98364dc14c379ab085f1b57d56b4b1a6f0100000000001e84800000000000000000000043010001af7afe0fac8958cb5e29f2bf7cbffa583d697642fc52202593844de0198eda2416c3d709acb082e2436ca4684242580edfd9e23a05fc1d22381b66e9ce7b41a8fd4d0b60230000000000000001e0250118a0844aa445459d910745838083a32b4459d0f3c48dbee068a3acddbf036f144b92c8498c81f8394bc8ac9328812c72ea5912dd7b2751b438e0044458d8f9a982002438aad8dfb4d82670c5fb8581adc5ec9995c2985c1bbda20e06bacad0e2d64cf6276c14dc636f2a4c1ef90e3fdd26da2a14ebef073007515135b6b723f0d7fa0ddaa3a26d8236848f971f3e46e1f0987c51637b2a5cc3592a7e9e9f51d46abf4eba9c4af01eb5bb0f43bcbc2ac3cf9c353599a352e5c1a8eb14a6e1a933a8f27ed8eddc42d9b5300ddc65dc8e7762680a766309295afcf104ac9dd01c3e6dfdf21c4ea2c1e204c16a5e26e5dc9497d3fe68165306cb15796a49e0faf29a57a63254c8bb2510d4640c70ec554827134f5320e5145004d1f9057d726e72aca6cc1302d8e65cd72c04fd0acad31a76fb8e26e09a0588f938d45a9af2dc2eef0ff730ab5db565907dffd95f0081f5ed4dfa20ba1fc90e77fe847a5987b74cf579bc637c3899019789f5cf01f456b8ad25b5a1f93c3f6a094e10b6f4ff0cc33baa232c1eeba64d228611360478a46f3684f3f6baef85de2c464fcc8cf555f144f3d9064f9fca49cf4a6d386bc9e972c412e6883ede59276dd4f987d1cee9a62f3056aff7e8de491dc4fb3091e825fac882f78d65d8869dc6c6a92c1c29ca1b4c6697f1fbc82c19bc87903e6e641712d642fcf98ccad976d548f05be51ecc8e3fc187c480a05f24038fd181bc725d1bfec6660918547ba5c0cc52bc84bfe060cbee79d1282f29c9188d9e419750c876db5d617054f63e0102bd2ac4dceeb1eb35d7f21ff89d33abe327f50b439e0a40df60d7180434afac2533b527b0a09c03e9ec584139c998a8c40c219c02b3e46d2906449a5718534ae42bb08b7280c642232c7d096145a5cf55a506e7cda90b3680bc6741d2c49d607b82e7d385a83c39f3588f6a800da67e8e2bc52ddf3d0af57b13fa30fea69029c81f31d6024241fe07f2220daa82f48a22c7cf2cddc37d8c2825474937c06503454bed674be66272351b9e2594e5dc51c0d368bfa7317b8d6cd38513560aa23d3de94077013cac08c754a03541a8166cb84f0e42c54e854bf1dc4ab360c602edb757c002f525adb73bed3b02ddd2be6a15946a4fcf7df05b6fc5fb25ef53776b842a892c333a211b03ef93976d632487e537b7d29e6c729b689c653d583c1f84d893cbfd93d022234d56d18d6913634fd84c13c7355ac079ed241f63002cc66c4c1039a6cc7bfaa0b829f26029e24084f333b62285a38c7691443b1c46c4b16770eeb98df095d3fb0b2d8e1672f44a2917dcbe8ba0b34455531f4f70cbbfa0a3ba29e910ff89f3abb03cda9b18e94cfb0fe7a06be47b4ebe55516c12d934d77b3094021bcb8eae0ab2c0682431ea241fe31297e012d50a37495bd3213389b3f1773e4b71f3e36af7acfd76fbfe5efd05a72079f9b435487deff0af39cc9494aa6701ecd13c8df63e903bd393f019dd142c9bfd32ed907979ec6b5538e0f83f3d241b7b5c1ec43a768b9b9633a270f1cd52a6a8e0e24ab42320ccef65068b8dbabe11ada9c52fb2397d95fd80e01883741c9cf432fa595b0478927287b8fc97fe2b32b31beec70e01cfd33c2bcfc99843f37aa79ee26420cd353efaa6af07a86e9c5bb78cc6dc660f8f90082166afda7376aace01a647fa1c0f7bd4331fc746c0b289cce18394e94a06650064a4a5714b3ec7b2ff0601d2c47b333f474a9081c03b67d60d76f5106b433a1f75548bc94dc0dbed2ebc530b97461b6b2d7b389bde139508efab618aad0a00b7a4f7432711822edda850f4d016b54650a19380c9d6d8f35d1f8895b10efd6bafa8974aae10ba06ce6b8d543e0e6901caabfc2e2d93143a10ddc0c4eb224b1b667531da61d86f4c8f0ef8c3a1d1af0452883b5c509f5e3a94bbf258900dcb95fb44c4f014711dcd7709f807b02ed73739728d49f7bf77f875f0e08d4d4f66bc737680f9be446d47b8df09307fff17cfbda0e5f7b643f67dcc5e8c0cb617a55fc7c5c4d90f82c3227c847a269b59a5ba158e807b40d3597be6864965a94383b54f78211a9db2086e3506f9c2be3f1f594a3f6e1b7ff4132d07ad434985bbaf433522a253b680350b45cfeba3f01c2c879491e91da708721f742bddbe95fd4bb85864e2441cd2b18a0e52c00a93b4949fe55554046e6ca3cb375529a9047fad2d94e7d9d637cfc14a98bac83a09486f77a12820f855ee049e585dc22beac15623bcd46ca7fe0ed22bb2207b391219f5e6f17f3601dda5cd0f447f4415773f3d335838bf1cac8ebe30c272eb7fdd84dd5cf23e5d828c465917484c33253bf8d55ea526730537f3778064261c1ffc9771984bed7a8735d9ab2ac5d77a0a92cd36a4d599aad2f995093aa850c5189c3474eb88a5011d9a7f8fa384fbd67a6b72d16558b9189549c6b6741a8e39545061a26132830c52587e7a17e341db0f814bc9805d61e585afd6b80773708d9a1ca5fd7b3cbd9858c70956cd4653907dca3ea7514b5c9ec6b792c8784ea1dce31a7f995ac0f6cd8944f2de17a534b9246edd6f3244576da984ea68fda9e2517c5999d38d9a93b95d6feab3d116ee58e944102745c0665e6e96d5174ffdbbb8ead695426cf75d846c3a984a7dc6b160c77f3ee6183e0d25128570b2f408437c026dc81d096ed2b9af5d2bda88a559e622d2dc003e6f69f6f668f2f0395908ea0d4397af1ba67d765ea5b29014a7ef5c4912274d1ab9f03d4ec620bf5a6898f52c16c913261f8247fe2f4fe2a0e66dd5de328aaa47261233b122f742e1847b4b17f50a4a8884f972e8acc4ae5b05ee3a6b89644dc7a96e69e2af6e7c7610c2b37c46eca8476809df0bfa80ecccecc57039701b7ed1eea672bcd040ffd008fe04adf08c7de800c87a5e8765b190448e750697ee0c4b2799087cea4cf4ed629f4bdadb3c34dfe2ae8d713d422e2e278965d8df3524bbc51a0245aea62da7ae9eddf50a05e68f64831cf87af74a913a6f1a72658729f20156a9015290b146f0e1d4e952a2c41029a6c99f3fcc04d137a581e4d79783060e48cb0a15f2cbe700ead4a5c76f4e358732dad40cbcb3ef22f7c23cc83cc2cb87c0f1a0af7ea0ff2b2f07d3295c5802c72a5259adcd62b811266acff286ca82e8a82a472507482903dc19cef48b7667e70272d88749e16358221d81fa6fce2fc0f7a09a47977591c1ea8c1b68e90d51bc71ac2f6c75d4da55a1001d0f0bda00d6fcc5214abd612fecfa574f1261b155e53d7796eb20f4f79e1a5f5d998550dcec04519089a76ac54ceee539ec0e083c9fe086e987c4f57e851be2de566bd16b1b1b0c1a6bf50b7358dad05b430524c24caa54da966d3089cde72d56dfbde10bbf145c0a463bafacc5d60482e0379007de62b479b220efa1ec03237d4660ebe750978ed36beeaa5120f88cd452c27a8d3c272eb0e63e51090760aeabb290c9bad499df11bf483fe0abbff5a776ccf6257d2cab760913239dd95e60b83df7ecccd4bbcebf4bdb058af3fd03db1303a8a2c351410862edc4b7f0eb69d4fbe91c4be12128645bd69149ad7cbead16a01d4fbc0031b065bb388752fc1a4c638c4a22134fd7a95c0674b2db433fca6a0738ca4b96b39d4f8aec2a44e1e3847d917c5724f1d92b3a0eb4398f9bf21bd38d7cdf233212462e233eac78a3863cffa3e60e526bf18ff28c01e1ee66fb0dfd2d1b071e8fdf93e0d5a04f9d02092d8ea79c9cff46db900acfd12f469d3cdfe7afc8ef5a7da92e561ab9cabab7711bdbcf630030f2cc2dd1494a64768125b7f450aa825cedb0f7224e17a59d7e2b3409b406ee5d31548f35d07336886b53bb30fb3ae233dfeffabc1763efb2cf6430dd07a0aad33636254f90cbbbf1eca63f52f72bae63c3b74ff3f522a0f1b1e61c7ea60222e09444184ba342a935c4e8d028398fe8b602cbe11b441c96007d3233d5adac8425fa1334282cc689a6b49a7c21ad092738a7317bb6e34328b77e7077aeff9a52db2aedf24cb318e740e0486e9763390fd6660d52ca76de07aa7b564540815a0000'
    }
];
const index = 0;
const script = '76a9142915bb05e68c73d424407c3687cf5c3ba7919aee88ac';
const value = null;
const sighash = SIGHASH_ALL;
const flags = 0;

const privkey = '96d6857485361b591c3d392f128fd55c9384d53e37558533be4c83e637e468c1';
const pubkey = '03379181919a0925651f945ad91a1637007be9bd7e3be6db97907732d406a4a65e';

test('Transaction', function(t) {
    t.plan(cases.length * 4);

    cases.forEach((item) => {
        var tx_hex = item.tx_hex;

        wally.wally_tx_get_elements_signature_hash(
            tx_hex,
            WALLY_TX_FLAG_USE_WITNESS + WALLY_TX_FLAG_USE_ELEMENTS,
            index,
            Buffer.from(script, 'hex'),
            value,
            sighash,
            flags
        ).then((tx_hash) => {

            t.equal(Buffer.from(tx_hash).toString('hex'), item.tx_hash);

            return wally.wally_ec_sig_from_bytes(
                Buffer.from(privkey, 'hex'),
                Buffer.from(tx_hash),
                EC_FLAG_ECDSA
            );

        }).then((signature) => {

            t.equal(Buffer.from(signature).toString('hex'), item.signature);

            return wally.wally_ec_sig_to_der(Buffer.from(signature));

        }).then((der) => {

            t.equal(Buffer.from(der).toString('hex'), item.der);
 
            var sig_der = Buffer.from(der);
            var sighash_byte = Buffer.from([sighash]);
            var signature = Buffer.concat([sig_der, sighash_byte]);
            var sig_len = Buffer.from(signature.byteLength.toString(16), 'hex');
            var pub_buf = Buffer.from(pubkey, 'hex');
            var pub_len = Buffer.from(pub_buf.byteLength.toString(16), 'hex');

            var scriptsig = Buffer.concat([
                sig_len,
                signature,
                pub_len,
                pub_buf
            ]);
        
            var tx_length = Buffer.from(tx_hex, 'hex').byteLength;
            var script_len = scriptsig.byteLength;

            return wally.wally_tx_set_input_script(
                tx_hex,
                WALLY_TX_FLAG_USE_WITNESS + WALLY_TX_FLAG_USE_ELEMENTS,
                index,
                scriptsig,
                tx_length + script_len
            )

        }).then((signed_tx) => {
            t.equal(Buffer.from(signed_tx).toString('hex'), item.signed_tx);

            console.log('tx: ', Buffer.from(signed_tx).toString('hex'));
        });
    });
});

/**
 * multisigトランザクションの署名用データ
 * sigscript に redeem script をセットする。
 * 
 * der_signature_length + der_signature + sighash + redeem_script_length + redeem script 
 */
